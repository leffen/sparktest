name: Deploy SparkTest MVP to Droplet

on:
  release:
    types: [published]
  workflow_dispatch: # Allow manual deployment

jobs:
  deploy:
    runs-on: [self-hosted, spark-runner]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Docker access and validate environment
        run: |
          echo "ðŸ³ Setting up Docker access..."
          echo "Current user: $(whoami)"
          echo "User groups: $(groups)"
          echo ""

          # Check if docker command exists
          if command -v docker &> /dev/null; then
            echo "âœ… Docker command found"
            docker --version
          else
            echo "âŒ Docker command not found"
            exit 1
          fi

          # Check Docker socket info
          echo "ðŸ” Docker socket information:"
          if [ -S /var/run/docker.sock ]; then
            ls -la /var/run/docker.sock
            DOCKER_GID=$(stat -c '%g' /var/run/docker.sock)
            echo "Docker socket group ID: $DOCKER_GID"
          else
            echo "âŒ Docker socket not found"
            exit 1
          fi

          # Fix Docker access permanently
          echo "ï¿½ Fixing Docker access..."

          # Method 1: Add user to existing docker group and create one with correct GID
          sudo groupadd -f -g $DOCKER_GID docker_host || true
          sudo usermod -aG docker $(whoami) || true
          sudo usermod -aG docker_host $(whoami) || true

          # Method 2: Fix socket permissions as backup
          sudo chown :docker /var/run/docker.sock || true
          sudo chmod 666 /var/run/docker.sock || true

          # Method 3: Use newgrp to apply group membership immediately
          echo "ðŸ”Œ Testing Docker access..."

          # Test Docker access with different methods
          if docker info > /dev/null 2>&1; then
            echo "âœ… Docker accessible directly"
          elif newgrp docker <<< 'docker info > /dev/null 2>&1' 2>/dev/null; then
            echo "âœ… Docker accessible via newgrp docker"
            # Export this for other steps
            echo "DOCKER_ACCESS_METHOD=newgrp_docker" >> $GITHUB_ENV
          elif newgrp docker_host <<< 'docker info > /dev/null 2>&1' 2>/dev/null; then
            echo "âœ… Docker accessible via newgrp docker_host"
            echo "DOCKER_ACCESS_METHOD=newgrp_docker_host" >> $GITHUB_ENV
          else
            echo "âš ï¸  Direct Docker access still not working, but container should handle this"
            echo "Continuing with deployment..."
          fi

          echo ""
          echo "ðŸ” Validating deployment environment..."

          # Test Docker functionality with fallback methods
          echo "ðŸ³ Testing Docker functionality..."
          DOCKER_CMD="docker info"

          if docker info &> /dev/null; then
            echo "âœ… Docker is working correctly"
            docker version --format 'Docker version: {{.Server.Version}}'
          elif [ "$DOCKER_ACCESS_METHOD" = "newgrp_docker" ] && newgrp docker <<< 'docker info' &> /dev/null; then
            echo "âœ… Docker working with newgrp docker"
            DOCKER_CMD="newgrp docker <<< 'docker'"
          elif [ "$DOCKER_ACCESS_METHOD" = "newgrp_docker_host" ] && newgrp docker_host <<< 'docker info' &> /dev/null; then
            echo "âœ… Docker working with newgrp docker_host"  
            DOCKER_CMD="newgrp docker_host <<< 'docker'"
          else
            echo "âŒ Docker is not working properly"
            echo "Debug info:"
            echo "Current groups: $(groups)"
            echo "Docker socket: $(ls -la /var/run/docker.sock 2>/dev/null || echo 'not found')"
            exit 1
          fi

          # Test Docker Compose
          echo "ðŸ“¦ Testing Docker Compose..."
          if docker compose version &> /dev/null; then
            echo "âœ… Docker Compose is available"
            docker compose version
          elif newgrp docker <<< 'docker compose version' &> /dev/null; then
            echo "âœ… Docker Compose working with newgrp"
          else
            echo "âŒ Docker Compose not found or not working"
            exit 1
          fi

          echo "ðŸ“ Deploying SparkTest MVP from release: ${{ github.event.release.tag_name || 'manual-deploy' }}"
      - name: Deploy SparkTest MVP
        run: |
          set -e

          # Function to run Docker commands with proper access
          run_docker() {
            if docker "$@" 2>/dev/null; then
              return 0
            elif [ "$DOCKER_ACCESS_METHOD" = "newgrp_docker" ]; then
              newgrp docker <<< "docker $*"
            elif [ "$DOCKER_ACCESS_METHOD" = "newgrp_docker_host" ]; then
              newgrp docker_host <<< "docker $*"
            else
              docker "$@"
            fi
          }

          echo "ðŸ§¹ Cleaning up existing deployment..."
          # Stop and remove existing containers (don't fail if nothing exists)
          run_docker compose -f docker-compose.prod.yml down --remove-orphans || echo "â„¹ï¸  No existing deployment found to clean up"

          # Remove old images to free space (keep last 2 versions)
          echo "ðŸ—‘ï¸  Cleaning up old Docker images..."
          run_docker image prune -f || echo "â„¹ï¸  No images to prune"

          echo "ðŸ“¦ Building and deploying SparkTest MVP..."
          # Build and start services with better error handling
          if ! run_docker compose -f docker-compose.prod.yml up --build -d; then
            echo "âŒ Error: Failed to deploy SparkTest MVP"
            echo "ðŸ”§ Attempting diagnosis..."
            
            # Show docker compose version for debugging
            run_docker compose version || echo "Could not get docker compose version"
            
            # Check if docker-compose.prod.yml exists and is valid
            if [ ! -f "docker-compose.prod.yml" ]; then
              echo "âŒ docker-compose.prod.yml not found!"
              ls -la *.yml *.yaml || echo "No YAML files found"
              exit 1
            fi
            
            echo "ðŸ“‹ Docker compose config validation:"
            run_docker compose -f docker-compose.prod.yml config --quiet || echo "Config validation failed"
            
            echo "ðŸ“‹ Checking logs for errors..."
            run_docker compose -f docker-compose.prod.yml logs --tail 50 || echo "Could not get logs"
            
            echo "ðŸ“‹ System resources:"
            df -h || echo "Could not check disk space"
            free -h || echo "Could not check memory"
            
            exit 1
          fi

          echo "â³ Waiting for services to be healthy..."
          sleep 45

          # Check service health with timeout
          echo "ðŸ“‹ Service status:"
          if ! run_docker compose -f docker-compose.prod.yml ps; then
            echo "âš ï¸  Could not get service status, trying with different approach..."
            run_docker ps -a || echo "Could not list containers"
          fi

          echo "ðŸ“‹ Recent logs:"
          run_docker compose -f docker-compose.prod.yml logs --tail 20 || echo "Could not get recent logs"

          # Get server IP
          SERVER_IP=$(hostname -I | awk '{print $1}' || echo "localhost")

          echo "âœ… SparkTest MVP deployed successfully!"
          echo "ðŸŒ Frontend: http://$SERVER_IP"
          echo "ðŸ”§ Backend API: http://$SERVER_IP:8080"

      - name: Deployment summary
        if: always()
        run: |
          echo "ðŸŽ‰ SparkTest MVP deployment workflow completed!"
          echo ""
          echo "ðŸ“Š Deployment status: ${{ job.status }}"
          echo "ðŸ·ï¸  Release version: ${{ github.event.release.tag_name }}"
          echo ""
          if [ "${{ job.status }}" != "success" ]; then
            echo "âŒ Deployment failed. Common issues:"
            echo "- Docker not available or not running"
            echo "- Insufficient resources (CPU/Memory/Disk)"
            echo "- Port conflicts (80, 8080 already in use)"
            echo "- Build failures in Rust or Node.js"
            echo ""
            echo "ðŸ”§ To troubleshoot:"
            echo "- Check runner system resources"
            echo "- Verify Docker and Docker Compose installation"
            echo "- Review action logs above for specific errors"
            echo "- Check available ports: sudo netstat -tlnp | grep ':80\\|:8080'"
          else
            echo "âœ… SparkTest MVP is now running!"
            echo ""
            echo "ðŸŒ Access your application:"
            echo "   Frontend: http://$(hostname -I | awk '{print $1}'):80"
            echo "   Backend API: http://$(hostname -I | awk '{print $1}'):8080"
            echo ""
            echo "ðŸ”§ Management commands:"
            echo "   View logs: docker compose -f docker-compose.prod.yml logs -f"
            echo "   Stop services: docker compose -f docker-compose.prod.yml down"
            echo "   Restart: docker compose -f docker-compose.prod.yml restart"
            fi
