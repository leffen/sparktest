name: Deploy SparkTest MVP to Droplet

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual deployment

jobs:
  deploy:
    runs-on: [self-hosted, spark-runner]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Docker if needed
        run: |
          echo "ğŸ³ Ensuring Docker is available..."

          # Check if Docker is already installed
          if command -v docker &> /dev/null; then
            echo "âœ… Docker is already installed"
            docker --version
          else
            echo "ğŸ“¦ Installing Docker..."
            # Install Docker using the official installation script
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh

            # Add current user to docker group to run without sudo
            sudo usermod -aG docker $USER

            # Start and enable Docker service
            sudo systemctl start docker
            sudo systemctl enable docker

            echo "âœ… Docker installation completed"
            docker --version
          fi

          # Ensure Docker service is running
          if ! sudo systemctl is-active --quiet docker; then
            echo "ğŸ”§ Starting Docker service..."
            sudo systemctl start docker
          fi

          echo "âœ… Docker is ready"

      - name: Validate deployment environment
        run: |
          echo "ğŸ” Validating deployment configuration..."

          # Check Docker availability
          if ! command -v docker &> /dev/null; then
            echo "âŒ Error: Docker is not installed"
            exit 1
          fi

          # Try Docker without sudo first, then with sudo if needed
          if docker info &> /dev/null; then
            echo "âœ… Docker is available and running"
          elif sudo docker info &> /dev/null; then
            echo "âœ… Docker is available and running (with sudo)"
            echo "âš ï¸  Note: Docker commands will require sudo"
          else
            echo "âŒ Error: Docker service is not running or not accessible"
            echo "ğŸ”§ Attempting to start Docker service..."
            sudo systemctl start docker
            sleep 5
            if sudo docker info &> /dev/null; then
              echo "âœ… Docker service started successfully"
            else
              echo "âŒ Error: Failed to start Docker service"
              exit 1
            fi
          fi

          echo "ğŸ“ Deploying SparkTest MVP from release: ${{ github.event.release.tag_name || 'manual-deploy' }}"

      - name: Deploy SparkTest MVP
        run: |
          set -e

          # Function to run docker commands with fallback to sudo
          run_docker() {
            if docker "$@" 2>/dev/null; then
              return 0
            elif sudo docker "$@"; then
              return 0
            else
              return 1
            fi
          }

          # Function to run docker compose commands with fallback to sudo
          run_docker_compose() {
            if docker compose "$@" 2>/dev/null; then
              return 0
            elif sudo docker compose "$@"; then
              return 0
            else
              return 1
            fi
          }

          echo "ğŸ§¹ Cleaning up existing deployment..."
          # Stop and remove existing containers
          run_docker_compose -f docker-compose.prod.yml down --remove-orphans || echo "No existing deployment found"

          # Remove old images to free space (keep last 2 versions)
          run_docker image prune -f || echo "No images to prune"

          echo "ğŸ“¦ Building and deploying SparkTest MVP..."
          # Build and start services
          if ! run_docker_compose -f docker-compose.prod.yml up --build -d; then
            echo "âŒ Error: Failed to deploy SparkTest MVP"
            echo "ğŸ“‹ Checking logs for errors..."
            run_docker_compose -f docker-compose.prod.yml logs --tail 50
            exit 1
          fi

          echo "â³ Waiting for services to be healthy..."
          sleep 45

          # Check service health
          echo "ğŸ“‹ Service status:"
          run_docker_compose -f docker-compose.prod.yml ps

          echo "ğŸ“‹ Recent logs:"
          run_docker_compose -f docker-compose.prod.yml logs --tail 20

          # Get server IP
          SERVER_IP=$(hostname -I | awk '{print $1}')

          echo "âœ… SparkTest MVP deployed successfully!"
          echo "ğŸŒ Frontend: http://$SERVER_IP"
          echo "ğŸ”§ Backend API: http://$SERVER_IP:8080"

      - name: Deployment summary
        if: always()
        run: |
          echo "ğŸ‰ SparkTest MVP deployment workflow completed!"
          echo ""
          echo "ğŸ“Š Deployment status: ${{ job.status }}"
          echo "ğŸ·ï¸  Release version: ${{ github.event.release.tag_name }}"
          echo ""
          if [ "${{ job.status }}" != "success" ]; then
            echo "âŒ Deployment failed. Common issues:"
            echo "- Docker not available or not running"
            echo "- Insufficient resources (CPU/Memory/Disk)"
            echo "- Port conflicts (80, 8080 already in use)"
            echo "- Build failures in Rust or Node.js"
            echo ""
            echo "ğŸ”§ To troubleshoot:"
            echo "- Check runner system resources"
            echo "- Verify Docker and Docker Compose installation"
            echo "- Review action logs above for specific errors"
            echo "- Check available ports: sudo netstat -tlnp | grep ':80\\|:8080'"
          else
            echo "âœ… SparkTest MVP is now running!"
            echo ""
            echo "ğŸŒ Access your application:"
            echo "   Frontend: http://$(hostname -I | awk '{print $1}'):80"
            echo "   Backend API: http://$(hostname -I | awk '{print $1}'):8080"
            echo ""
            echo "ğŸ”§ Management commands:"
            echo "   View logs: docker compose -f .deploy/docker-compose.yml logs -f"
            echo "   Stop services: docker compose -f .deploy/docker-compose.yml down"
            echo "   Restart: docker compose -f .deploy/docker-compose.yml restart"
          fi
